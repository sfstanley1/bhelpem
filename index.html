<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Data Dashboard</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Excel Data Dashboard</h1>
  <div>
    <label for="filter">Filter by Field (e.g. Status):</label>
    <select id="filter">
      <option value="">All</option>
    </select>
  </div>
  <canvas id="chart" width="600" height="400"></canvas>

  <script>
    const sheetURL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_mrh6CN8-3uFD-kyyvSRynnNDQHsYe67HQ-e8fs-45yKKFgx_jU-rsiEigT2j2vjjHPz_HA4JFLNUDKn8ZBpDzq57M9eQxnWsbPic5so1nvcYJkybY6H4vwhDPh68H8HnSo9IB14K36F2RPJDAAjJ1FXDkkFldrNYH6ewz0mrfcQ_tOjMfwApzgrP3JBvcYn1vTXJdUaDybqPqGeQ9ULY2fjdUZQWbJe_H6e5mmXyo9AltzjEkkyYCyNX8QAG43ZP1VdvroJsSsPdJWhb2gG8MlLFlccbITEm_ZGn&lib=MfiO_3z2Y8SaQfcuLd8CSm-45iJMEkhdC";

    const filterSelect = document.getElementById('filter');
    const chartCanvas = document.getElementById('chart');
    let rawData = [];
    let chart;

    async function fetchExcelData(url) {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: "array" });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);
      return jsonData;
    }

    function updateFilterOptions(data, field = "Status") {
      const uniqueValues = [...new Set(data.map(item => item[field]))];
      filterSelect.innerHTML = `<option value="">All</option>`;
      uniqueValues.forEach(value => {
        filterSelect.innerHTML += `<option value="${value}">${value}</option>`;
      });
    }

    function filterData(value, field = "Status") {
      return value ? rawData.filter(item => item[field] === value) : rawData;
    }

    function renderChart(data, field = "Status") {
      const counts = data.reduce((acc, item) => {
        acc[item[field]] = (acc[item[field]] || 0) + 1;
        return acc;
      }, {});
      const labels = Object.keys(counts);
      const values = Object.values(counts);

      if (chart) chart.destroy();
      chart = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: `Count by ${field}`,
            data: values,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    filterSelect.addEventListener("change", () => {
      const filtered = filterData(filterSelect.value);
      renderChart(filtered);
    });

    // Initial load
    (async () => {
      rawData = await fetchExcelData(sheetURL);
      updateFilterOptions(rawData);
      renderChart(rawData);
    })();
  </script>
</body>
</html>
